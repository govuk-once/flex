# FLEX - Core Infrastructure Overview

This directory holds the Terragrunt wrapper around our Terraform modules. We follow a **root + per‑environment** layout so we can keep shared logic DRY while still customising AWS account details for each environment.

## Layout

- `root.hcl` – shared locals, generated provider/backend blocks, and any other global defaults. Every environment includes this file.
- `envs/<env>/account.hcl` – environment‑specific metadata (e.g. AWS account ID, friendly name).
- `envs/<env>/terragrunt.hcl` – entry point for that environment. It reads the local `account.hcl`, exposes any required inputs (such as `aws_account_id`), and includes `root.hcl`.
- `envs/<env>/provider.tf` – generated by Terragrunt when you run `init`. **Do not edit manually.**

Add new environments by copying one of the existing env folders, updating its `account.hcl`, and adjusting the Terragrunt inputs as needed.

## Prerequisites

<!-- TODO: consider mise for terraform, aws, terragrunt, node etc versioning -->

- Terraform CLI (>= 1.5)
- Terragrunt CLI (>= 0.58)
- AWS credentials for the target account loaded in your shell (via SSO, AWS Vault, or environment variables)

## Workflow

Workflow

1. `cd infra/envs/<env>`
2. `terragrunt init` (first run or when dependencies change)
3. `terragrunt plan` to review changes
4. `terragrunt apply` to make changes once the plan is approved
5. `terragrunt output` to inspect values, or run module‑level tests as part of your pipeline

Use `terragrunt run-all plan` / `run-all apply` only when you intentionally need to act across multiple modules under the current directory tree. From within `infra/envs`, that will hit every environment; inside `infra/envs/dev`, it affects just the modules nested under `dev/`.

## Common Commands

- `terragrunt hcl fmt` – format all Terragrunt files (run before committing)
- `terragrunt validate` – validate Terraform configuration via Terragrunt
- `terragrunt output` – print outputs for the working directory
- `terragrunt run-all <command>` – execute a command across all sub-directories discovered from the current path (use with care)

## Troubleshooting Tips

- If `find_in_parent_folders` can’t locate `account.hcl`, ensure you’re running commands from inside an environment folder (e.g. `infra/envs/dev`).
- Generated files such as `provider.tf` should be committed only if explicitly required; otherwise they can stay ignored.
- When the provider block fails to see environment locals, confirm the env `terragrunt.hcl` exports the data via `inputs` so `root.hcl` can render with `${inputs.<name>}`.
